#!/usr/bin/env bash
set -euo pipefail

# install-ssh-key: Unlock Bitwarden, pick an SSH key, save to ~/.ssh/

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing dependency: $1" >&2; exit 1; }; }

need bw
need jq

have_fzf=0
if command -v fzf >/dev/null 2>&1; then
  have_fzf=1
fi

SSH_DIR="$HOME/.ssh"

ensure_ssh_dir() {
  if [[ ! -d "$SSH_DIR" ]]; then
    mkdir -p "$SSH_DIR"
    chmod 700 "$SSH_DIR"
  fi
}

ensure_logged_in() {
  echo "Checking Bitwarden login status..."
  local status
  status="$(bw status | jq -r '.status')"
  echo "Status: $status"
  if [[ "$status" == "unauthenticated" ]]; then
    echo "Bitwarden CLI is not logged in. Running: bw login"
    bw login
  fi
}

unlock_vault() {
  echo "Unlocking vault..."
  BW_SESSION="$(bw unlock --raw)" || {
    echo "bw unlock failed." >&2
    exit 1
  }
  if [[ -z "$BW_SESSION" ]]; then
    echo "Failed to unlock Bitwarden vault (empty session)." >&2
    exit 1
  fi
  export BW_SESSION
  echo "Vault unlocked. Session length: ${#BW_SESSION}"
}

list_ssh_key_items() {
  echo "Syncing vault..." >&2
  bw sync >/dev/null 2>&1 || true
  echo "Sync complete. Listing SSH keys..." >&2
  bw list items | jq -r '
        map(select(.sshKey? and (.sshKey.privateKey? != null)))
        | sort_by(.name)
        | .[]
        | (.name // "Unnamed") + "\t" + .id
      '
  echo "Filtering done." >&2
}

pick_item() {
  local items_tsv="$1"

  echo "pick_item called with: '$items_tsv'" >&2

  if [[ -z "$items_tsv" ]]; then
    echo "No SSH keys found in your vault."
    echo "Make sure your keys are stored as Bitwarden 'SSH Key' items."
    exit 0
  fi

  echo "Found keys, have_fzf=$have_fzf" >&2

  if [[ $have_fzf -eq 1 ]]; then
    echo "Launching fzf..." >&2
    echo "$items_tsv" \
      | fzf --prompt="Select SSH key to install > " \
            --with-nth=1 \
            --delimiter=$'\t' \
      | awk -F $'\t' '{print $2}'
  else
    mapfile -t lines < <(printf "%s\n" "$items_tsv")
    echo "Select an SSH key to install:" >&2
    local i=1
    for line in "${lines[@]}"; do
      printf "  %d) %s\n" "$i" "$(cut -f1 <<<"$line")" >&2
      i=$((i+1))
    done
    printf "Enter number: " >&2
    read -r choice </dev/tty
    if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#lines[@]} )); then
      echo "Invalid selection." >&2
      exit 1
    fi
    cut -f2 <<<"${lines[$((choice-1))]}"
  fi
}

detect_key_type() {
  local private_key="$1"
  if [[ "$private_key" == *"BEGIN OPENSSH PRIVATE KEY"* ]]; then
    # Could be ed25519, ecdsa, or newer rsa - check the key itself
    if [[ "$private_key" == *"ssh-ed25519"* ]] || ssh-keygen -l -f /dev/stdin <<<"$private_key" 2>/dev/null | grep -q ED25519; then
      echo "id_ed25519"
    elif ssh-keygen -l -f /dev/stdin <<<"$private_key" 2>/dev/null | grep -q ECDSA; then
      echo "id_ecdsa"
    else
      echo "id_rsa"
    fi
  elif [[ "$private_key" == *"BEGIN RSA PRIVATE KEY"* ]]; then
    echo "id_rsa"
  elif [[ "$private_key" == *"BEGIN EC PRIVATE KEY"* ]]; then
    echo "id_ecdsa"
  else
    echo "id_ed25519"
  fi
}

install_key() {
  local id="$1"

  local item
  item="$(bw get item "$id")"

  local private_key public_key key_name
  private_key="$(echo "$item" | jq -r '.sshKey.privateKey')"
  public_key="$(echo "$item" | jq -r '.sshKey.publicKey // empty')"
  key_name="$(echo "$item" | jq -r '.name // "Unnamed"')"

  if [[ -z "$private_key" || "$private_key" == "null" ]]; then
    echo "Error: No private key found for this item." >&2
    exit 1
  fi

  local base_name
  base_name="$(detect_key_type "$private_key")"

  local private_path="$SSH_DIR/$base_name"
  local public_path="$SSH_DIR/$base_name.pub"

  # Check for existing keys
  if [[ -f "$private_path" ]]; then
    echo "Warning: $private_path already exists."
    read -rp "Overwrite? [y/N] " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 0
    fi
  fi

  # Write private key
  printf '%s\n' "$private_key" > "$private_path"
  chmod 600 "$private_path"
  echo "Installed private key: $private_path"

  # Write public key if available
  if [[ -n "$public_key" && "$public_key" != "null" ]]; then
    printf '%s\n' "$public_key" > "$public_path"
    chmod 644 "$public_path"
    echo "Installed public key:  $public_path"
  else
    # Generate public key from private key
    if ssh-keygen -y -f "$private_path" > "$public_path" 2>/dev/null; then
      chmod 644 "$public_path"
      echo "Generated public key:  $public_path"
    else
      echo "Warning: Could not generate public key."
    fi
  fi

  echo
  echo "Installed '$key_name' as default SSH key."
}

main() {
  ensure_ssh_dir
  ensure_logged_in
  unlock_vault

  items="$(list_ssh_key_items)"
  selected_id="$(pick_item "$items")"

  if [[ -z "$selected_id" ]]; then
    echo "No selection made. Exiting."
    exit 0
  fi

  install_key "$selected_id"
}

main "$@"
